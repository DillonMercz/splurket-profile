<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="croppie/croppie.css">
    <script src="croppie/croppie.js"></script>

    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container text-center">
        <div id="AddAlert" class="alert alert-warning alert-block" style="display:none;">
            <p id="AddAlertMessage"></p>
        </div>
            <div class="mt-3 row">
                <div class="col-md-6">
                    <div id="uploaded_pic">
                        <img id="myImage" class="img-thumbnail img-chosen" alt="Your image!"
                            src="img/avatar_placeholder_temporary.png">
                    </div>
                    <input hidden type="file" accept="image/*" name="upload_image" id="upload_image"><hr>
                    <button id="btnGrab" class="btn btn-success">Select New</button>
                    </div>
                    <br>
                </div>
            </div>
    </div>


    <!-- The Modal -->
    <div class="modal" id="uploadImageModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Crop Image</h4>
                    <button id="closeModal" type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <div id="image_demo" style="width: 300px;"></div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button id="confirmCrop" type="button" class="btn btn-success">Confirm!</button>
                </div>

            </div>
        </div>
    </div>
</body>
<script>
    $("#myImage").click(function() {
        $("input[id='upload_image']").click();
});
</script>
<script>
    $(function () {
        $image_crop = $('#image_demo').croppie(
            {
                enableExif: true,
                viewport: {
                    width: 150,
                    height: 150,
                    type: 'circle'
                },
                boundary: {
                    width: 300,
                    height: 300
                }
            });

        $('#btnGrab').click(function () {
            $('#upload_image').click();
        });

        var selectedFile;

        $("#upload_image").change(function (evt) {
            if ((selectedFile = evt.target.files[0])) {
                validateImageSizeType(selectedFile);
            }
        });

        function validateImageSizeType(selectedImage){
            var _URL = window.URL || window.webkitURL;
            var img = new Image();

            img.onload = function() {
                if(this.width >= 200 && this.height >= 200){
                    readImgShowModal(selectedImage);
                }
                else
                {
                    showAlert("This image doesn't have the minimum size required: 200px / 200px");
                    $('#upload_image').val('');
                }
            };

            img.onerror = function() {
                showAlert("File type not valid: " + selectedImage.type);
            };
            
            img.src = _URL.createObjectURL(selectedImage);
        }

        function showAlert(msj) {
            $('#AddAlertMessage').html(msj);
            $("#AddAlert").show();
            setTimeout(function () { $("#AddAlert").hide(); }, 3500);
        }

        function readImgShowModal(selectedImg){
            
            //document.getElementById("upload_image").value = "";
            $('#upload_image').val('');

            var reader = new FileReader();
            reader.onload = function (event) {
                $image_crop.croppie('bind', {
                    url: event.target.result
                }).then(function () {
                    console.log('Bind complete!');
                });
            }
            reader.readAsDataURL(selectedImg);
            $('#uploadImageModal').modal({
                appendTo: $(window.parent.document).find('body'),
                overlayCss: {backgroundColor:"#333"}, // Optional overlay style
                overlayClose:true, 
            });
            // Set overlay's width
            $(window.parent.document).find('#simplemodal-overlay').css('width', '100%');
        }

        $('#closeModal').click(function(){
            var vmyImage = document.getElementById("myImage");
            var vmyImg = new Image();

            vmyImage.title = "Your image!";
            vmyImg.title = "Your image!";

            var nameImage = document.getElementById("nameMyImage");
            var nameImg = document.getElementById("nameMyImg");

            nameImage.innerHTML = "avatar";
            nameImg.innerHTML = "avatar";
            
            vmyImage.src = "img/avatar-default-icon.png";
            vmyImg.src = "img/avatar_placeholder_temporary.png";

            vmyImg.className = "img-thumbnail img-chosen";
            vmyImg.alt = "Your image!";

            document.getElementById('myImg').innerHTML = "";
            document.getElementById('myImg').append(vmyImg);
        });

        $('#confirmCrop').click(function () {
            $image_crop.croppie('result', {
                type: 'canvas',
                size: 'viewport'
            }).then(function (response) {            
                $('#noteInfo').html('You can select another picture!');

                withJSpure(response);

                $('#nameMyImg').html(selectedFile.name);

                $('#myImg').html('');
                $("<img>", {
                    "src": response,
                    "class": 'img-thumbnail img-chosen',
                    "alt": 'Your image!',
                    "title": selectedFile.name
                }).appendTo("#myImg");            

                $('#uploadImageModal').modal('hide');
            })
        });

        function withJSpure(resp) {
            var imgtag = document.getElementById("myImage");
            imgtag.title = selectedFile.name;

            var nameImg = document.getElementById("nameMyImage");
            
            imgtag.src = resp;
        }

        /*     $('#upload_image').change(function (evnt) {
                $('#noteInfo').html('You can select another picture!');
            
                onChangeUploadJSpure(evnt);
            
                var selectedFile = event.target.files[0];
                var reader = new FileReader();
            
                $('#myImg').attr('title', selectedFile.name);
                $('#nameMyImg').html(selectedFile.name);
            
                reader.onload = function (event) {
                    $("#myImg").attr("src", event.target.result);
                };
            
                reader.readAsDataURL(selectedFile);
            }); */

        /* function onChangeUploadJSpure(evt) {
            var selectedFile = event.target.files[0];
            var reader = new FileReader();

            var imgtag = document.getElementById("myImage");
            imgtag.title = selectedFile.name;

            var nameImg = document.getElementById("nameMyImage");
            nameImg.innerHTML = selectedFile.name;

            reader.onload = function (event) {
                imgtag.src = event.target.result;
            };

            reader.readAsDataURL(selectedFile);
        } */
    });
</script>
</html>